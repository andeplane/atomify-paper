\documentclass[aps,pre,twocolumn,letterpaper,floatfix,nofootinbib]{revtex4}
\usepackage{graphicx} 
\usepackage{amsmath,amssymb,amsfonts} 
\usepackage{mathtools}
\usepackage{pdfpages}
\usepackage{afterpage}
\usepackage[hidelinks]{hyperref} 
\usepackage{epstopdf}
\usepackage{todo}
\usepackage{menukeys}

\begin{document}

\title{Atomify - a live LAMMPS visualizer}
\author{Anders Hafreager$^1$}
\author{Svenn-Arne Dragly$^{1}$} 
\author{Anders Malthe-S\o renssen$^1$}
\affiliation{$^1$Department of Physics - University of Oslo\\Sem S{\ae}lands vei 24, NO-0316, Oslo, Norway }
\date{\today} 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{abstract}
%
The typical LAMMPS workflow includes working with a text editor to modify
scripts, the terminal to run simulations, and programs like VMD or Ovito to
visualize trajectories.
If physical quantities are computed, the data is often plotted with MATLAB or
Python, where additional scripts must be used.
This is a tedious process, especially for teaching purposes and for people who
are new to LAMMPS.
We here introduce Atomify;
a high performance live visualizer for LAMMPS simulations,
with stunning graphics able to simulate and render more than 250,000 atoms with
excellent frame rate on modern hardware.
Atomify supports OpenMP and GPU acceleration, live plotting of LAMMPS variables
and computes, and an easy-to-use code editor in one single program.
Direct access to the powerful machinery already built into LAMMPS allows easy
access to advanced physical quantities.
Atomify is open-source software (GPL) written in C++ using the Qt framework.
%
\end{abstract} 
 
\maketitle

\section{Introduction}
%
Molecular dynamics (MD) is a common technique for simulating the motion of atoms, molecules and larger particles in a broad range of fields such as physics, chemistry and biology \cite{flerefelt}.
% TODO does MD also include larger particles?
% TODO which fields?
Over the years, increasingly sophisticated methods have been developed.
% TODO what methods?
With the large number of force fields, advanced techniques and GPU acceleration,
implementing a good molecular dynamics simulation is a challenging task.
There are many software packages for molecular modelling
available\footnote{\url{https://en.wikipedia.org/wiki/Comparison_of_software_for_molecular_mechanics_modeling} compares different softwares for molecular modeling.}.
Some packages, such as LAMMPS\cite{Plimpton1995Fast}, GROMACS\cite{Pronk2013}
and NAMD\cite{Phillips2005Scalable} have been developed for more than two decades 
and contain more than one million lines of code each.

The work in this paper is focused on LAMMPS.
Although the software is well-documented and enables the user to perform
advanced simulations, it can be demanding to learn how to use it well.
A LAMMPS simulation is performed by a series of commands which are executed one by
one.
Physical quantities such as energy, temperature and stress can be measured by
adding \textit{computes}.
The time evolution of these quantities can in turn be saved to file for plotting
and further analysis.
Particle trajectories can be saved to a file and visualized by tools such as
VMD\cite{Humphrey1996Vmd} or OVITO\cite{Stukowski2009Visualization}.
The lack of an intuitive GUI and visualization\footnote{GUI is listed as a non-feature on the web page:
\url{http://lammps.sandia.gov/non_features.html}.} makes the workflow somewhat
complicated, see figure \ref{fig:flowchart}.

Atomify solves combines script editing, simulation,
visualization, and analysis in one single software application.
It uses LAMMPS as a library and synchronizes after each timestep,
copying the relevant information from LAMMPS to the graphics processing unit
(GPU) for visualization and data plotting.
The visualization is optimized for high performance by raytracing billboards.
This allows visualization of millions of atoms with good framerate on desktop
computers. Atomify is designed with simplicity as main goal.

A simplified version of Atomify is made available for mobile platforms (Android
and iOS).
This version of Atomify provides access to some of the examples and is intended
for exploration of molecular dynamics simulations by students.
It also works as a demonstration of the visualization capabilities of the
desktop version of the software.
The authors are optimistic that teachers can use the visualizations provided by
Atomify to explain microscopic interactions underlying concepts in topics such
as thermodynamics, geophysics, and biology.
\begin{figure*}
	\centering
	\includegraphics[width=0.95\textwidth]{gui.png}
	\caption{%
    Overview of the Graphical User Interface (GUI) in Atomify.
    The toolbar (1) is used to change between the different modes, such as 
    editing, viewing and analyzing the running simulation, 
    in addition to playback controls.
    The file browser (2) contain the list of open LAMMPS scripts or data files.
    The text editor (3) provides code highlighting.
    The viewport (4) shows the current simulation.
    The simulation properties (5) shows the simulations details, gives access to 
    LAMMPS objects such as groups, regions and computes, and the rendering
    properties (6) lets you change the viewport settings, such as lighting and
    draw mode.
    TODO: Add numbers to figure.
    }
	\label{fig:gui}
\end{figure*}

\begin{figure*}
	\centering
	\includegraphics[width=0.95\textwidth]{flowchart.png}
	\caption{The typical workflow when using LAMMPS consists of multiple steps using several applications. a) A LAMMPS script is written using a text editor. b) Simulation is performed from the terminal. c) and d) visualization and analysis is performed using Ovito and \url{http://bit.ly/logplotter}. Atomify simplifies the workflow by combining all steps into a single application. }
	\label{fig:flowchart}
\end{figure*}

\section{Features}

The main features of Atomify are script editing,
live visualization, and live plotting of computed quantities.
In addition, Atomify comes packaged with multiple examples,
many of which have been made by members of the LAMMPS community.
These examples are easily explored within Atomify.

Atomify provides a lightweight script editor with syntax highlighting and line
numbers.
% TODO add built-in help and autocompletion to Atomify and mention here
Multiple files can be open at the same time and the state persist across working sessions.
The script can easily be restarted by clicking the button in the GUI or using
the default shortcut (\keys{Ctrl+R} in Windows and Linux or \keys{\cmd+R} in macOS).
This enables you to quickly do changes in the script and see the changes immediately. 

Certain Atomify-commands can be added to the comments of a regular LAMMPS script
to modify properties of the GUI.
All these start with \keys{\texttt{\#}} so that LAMMPS ignores them as they are
interpreted as comments.
For instance, the color and size of the atoms can be set based on the type by
the command \keys{\texttt{\#/atom}}.
To set the color to white and radius to 2.0 for particle type 1,
the user can apply the command \keys{\texttt{\#/atom 1 2.0 \#ffffff}}.
Certain built-in atom types have default values and can be accessed with
\keys{\texttt{\#/atom 1 oxygen}} for simplicity.
The initial camera position can also be set similarily.
For a full list of the available commands, see the Atomify
documentation\cite{atomifydocumentation}.

Atomify provides live visualization of particles in a simulation in its 3D view. 
The particles can be colored based on any produced per-atom quantity in LAMMPS such as
atom type, velocity, force or a variable formula.
The coloring scheme can be changed while the simulation is running by hovering
the mouse cursor over groups in the dashboard.
Light colors and strength can also be changed in the dashboard.
This will be described in further detail in the following section.

It is possible to organize particles in groups and regions in LAMMPS.
These are shown in the dashboard in Atomify, which also provides controls to
highlight or hide specific groups or regions.
To highlight a group or region, the user only needs to hover the name in the
dashboard.
The visibility icon can be clicked to hide a group or region.

Parameters for rendering, such as the light strength,
attenuation, and color can be modified in the Rendering tab of the dashboard.
See the above section about the script editor for information about how to
modify the color of the particles.

In LAMMPS, computes are computations performed on a group of atoms.
Variables are user defined expressions which can be used to combine values in
calculations.
Once defined in a LAMMPS script, these can be plotted as a function of time in
Atomify.
This is done by clicking the name of the variable or compute in the simulation
tab.
We will explore plots in further detail in the following section.

Any operation that is applied to the system in a LAMMPS timestep or minimization
step is called a ``fix''.
These fixes are defined in the LAMMPS script using the ``fix'' keyword.
Atomify registers all defined fixes and lists these in the dashboard.

In LAMMPS, computes are physical quantities calculated based on the running
simulation, such as energy, temperature and stress.
% TODO better word for measures?
These are typically macroscopic measures derived from the microscopic
interactions between the atoms.
Computes and variables are shown in the Atomify dashboard,
along with information about the regions, groups and fixes as shown in figure
\ref{fig:dashboard}.

\begin{figure}
	\centering
	\includegraphics[width=0.3\textwidth]{dashboard.png}
	\caption{Dashboard}
	\label{fig:dashboard}
\end{figure}

Computes can be plotted as a function of time and visualized while the 
simulation is running.
Quantities that are measured per atom can be plotted in a histogram or a 2D
average for each region.
Atomify provides live visualization of the compute values using various plotting
techniques.
For instance, the temperature of the simulated system can be plotted as a
function of time as seen in figure \ref{fig:temperature}.

\begin{figure}
	\centering
	\includegraphics[width=0.45\textwidth]{figures/temperature.png}
	\caption{Atomify can visualize computes defined in LAMMPS. 
    Here the temperature is plotted as a function of time.}
	\label{fig:temperature}
\end{figure}

\section{Implementation}

Atomify runs a LAMMPS instance in the background that the user can issue 
commands to and visualizes the current atom positions and the LAMMPS state.
The user can interact with LAMMPS while the simulation is running.
Atomify is written in C++ and QML using the Qt framework.
The GUI is developed in QML and LAMMPS communication,
computations, and rendering is mostly defined in C++.
High-performance visualization is implemented as billboards in Qt3D.

\subsection{Communicating with LAMMPS}

LAMMPS can be compiled as a library with most of its contents being accessable
through either the library interface or public variables in all classes.
LAMMPS provides a C++ API that can be used to access parts of the internal data
in the simulation as well as for issuing commands to LAMMPS.
Further, direct access to raw data in LAMMPS is available through the individual
C++ classes.

\begin{figure}
	\centering
	\includegraphics[width=0.5\textwidth]{figures/data-pipeline.pdf}
	\caption{Rendering in Atomify is based on modifying the data from LAMMPS
    by coloring, producing periodic images, and generating bonds between atoms.
    The data is extracted from LAMMPS using the library API and by accessing
    the core classes.}
	\label{fig:data-pipeline}
\end{figure}

The data pipeline from LAMMPS to rendering in Atomify is illustrated in figure
\ref{fig:data-pipeline}.
When rendering one often wants to modify the data from LAMMPS before it is
visualized.
Examples are periodic images of the simulation,
slicing and coloring.
We have been inspired by the pipeline used in Ovito where the data flows through
several \textit{modifiers}, each modifying the visualization data before the
data is converted to a format for the GPU.

\subsection{Rendering techniques}

Simulations of atoms are often visualized using spheres as atoms and cylinders.
The spheres represent the atoms while the cylinders represent the bonds between
the atoms.
This way, the molecular structure is easy to understand and interpret.
In many visualization tools, the spheres and cylinders are built up by many
triangles connected so they form the geometrical object of interest.
One problem with this rendering technique is that each sphere needs many,
often hundreds, of triangles in order to look spherical.
A common technique to overcome this problem is to use billboards.

Billboards are plane objects that are always facing the camera (their normal
vector always points from the billboard center towards the camera center).
Drawing a filled circle on the billboard is a simple approximation to rendering
spheres, but this approach suffers from unrealistic distortions from the field
of view and does not make it possible to render realistic lighting.
The more robust approach, which we have chosen,
is to cast rays from the camera to the plane and calculate the sphere
intersection of each ray.
The normal vector can then be found by subtracting the intersection point from
the sphere center.

The technique of using billboards with only four vertices instead of a mesh
approximating a sphere with many more vertices is often referred to as
\emph{imposter spheres} in the literature.
% TODO add reference to literature explaining the details of rendering spheres with imposter billboards
This technique significantly reduces the number of vertices sent from the CPU to
the GPU, which in turn improves rendering performance.
A sphere may consist of an arbitrary number of vertices,
depending on the level of detail needed.
A billboard will on the other hand consist of only 4 vertices and can be
represented as a point on the CPU which is then expanded on the GPU using shader
programming.
By doing proper shading, the billboards can mimick the spheres and cylinders so
they look realistic, see Figure \ref{fig:final_billboards}.

\begin{figure}
	\centering
	\includegraphics[width=0.5\textwidth]{final_billboard.png}
	\caption{Billboards can produce pixel perfect rendering of molecules. Here we see a water molecule being rendererd with two light sources showing specular reflection and diffuse light effects.}
	\label{fig:final_billboards}
\end{figure}

\subsection{Sphere billboards}

Each sphere is visualized as two triangles making up a square large enough to
cover all pixels the sphere needs.
To reduce the CPU workload, all 4 corner vertices of the square are placed at
the exact position of the sphere.
The radius and a vertex id is specified, so that the vertex shader can move the
4 vertices so that the plane is orthogonal to the view vector and is larger than
the cross sectional area of the sphere of interest.
This is illustrated in figure \ref{fig:billboards}.

\begin{figure}
	\centering
	\includegraphics[width=0.5\textwidth]{spherebillboards.png}
	\caption{Illustration of billboards. The circles are shown in the figure to show our target rendering. a) all 4 vertices are at the center of the sphere. b) the vertex shader moves each vertex so that the plane covers a larger cross sectional area than the sphere. c) the orientation of the plane is such that the normal vector of the plane is parallel to the view vector. }
	\label{fig:billboards}
\end{figure}

\subsection{Cylinder billboards}
%
% TODO should we use the other terminology here rather than billboards, something about imposter visualization?
To render bonds in the molecular structure, we have implemented a method that
visualizes realistic cylinder shapes with billboards.
Cylinders are more complicated to visualize with billboards because they have a
more complex geometry.
While spheres obviously are spherically symmetric and can be rendered the same
way regardless of viewing angle, we need to take this into account when
rendering cylinders.
Furhter, the bonds need to intersect with the sphere surface in a way that
needs to be handled by the cylinder rendering technique.

The basic principle is however the same as for the spheres.
We define the vertices needed on the CPU with the same position and add the
necessary information about the cylinder to the vertex attributes.
This information is then used in the vertex shader to draw the triangles of
the billboard.
Finally, ray tracing is used to draw the final cylinder shape based on top
of this billboard.

% TODO mention issue with end caps if this is relevant for the overlapping parts

% TODO explain the details about billboard rendering?

\section{Case study (Anders)}

% TODO Write about case study

\begin{figure}
	\centering
	\includegraphics[width=0.5\textwidth]{final_billboard.png}
	\caption{Case study result}
	\label{fig:gui}
\end{figure}

\section{Conclusion}
%
We have presented Atomify, a software for live visualization of molecular
dynamics simulations in LAMMPS.
Atomify simplifies the workflow of researchers by combining script development,
analysis and visualization in an intuitive user interface.
The software can also be used to improve training of students using LAMMPS by
providing immediate, visual feedback to script changes.

The simple case study showed how Atomify can be used for quick iteration in 

\subsection{Future work}

Atomify continues in heavy development and we have several features planned for
future versions.
A web version of Atomify using WebGL and WebAssembly will make it easy to test
scripts in the browser.
This is useful in educational settings where teachers wish to introduce students
to LAMMPS without installing additional software.
It will also serve as a nice demonstration of the full desktop application of
Atomify.

Performance improvements are planned by for instance using geometry shaders in
the rendering pipeline.
This allows a fourfold reduction in the number of vertices passed from the CPU
to the GPU.
Further, geometry shaders can be used for certain modifiers,
such as the periodic copies, which are currently performed on the CPU.

% TODO Reference to KOKKOS
We also aim to include more LAMMPS backends, such as KOKKOS, and running
simulations on computing clusters while visualizing them on the users own
computer.

The script editor will get features such as autocompletion of LAMMPS commands
and easy access to the online documentation by hovering or selecting specific
commands.

We are also working on including Moltemplate and other programs that generate
systems to make it easier for users to get started with more complex
simulations.

\section{Availability}

Atomify is availabe on Linux, MacOS and Windows and can be downloaded from
\href{https://ovilab.net/atomify}{http://ovilab.net/atomify}.
A lightweight version of the desktop application is also available for mobile
devices running Android or iOS.

\section{Acknowledgments}

\section{Disclosure}

Svenn-Arne Dragly is employed part-time by The Qt Company.

\bibliography{Remote}

\end{document}
